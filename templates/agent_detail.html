{% extends "base.html" %} {% block content %}

<div class="d-flex align-items-start justify-content-between mb-3">
  <div>
    <h1 class="h4 m-0">{{ agent.nom }} {{ agent.prenom }}</h1>
    <div class="text-muted">
      Matricule: {{ agent.matricule or "-" }} • Grade: {{ agent.grade or "-" }}
      • Caserne: {{ agent.caserne or "-" }}
    </div>
  </div>

  <a class="btn btn-outline-accent" href="{{ url_for('agents') }}">
    <i class="bi bi-arrow-left"></i> Retour
  </a>
</div>

<!-- AJOUT RESULTAT -->
<div class="card card-dark mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="h6 m-0">
        <i class="bi bi-plus-circle"></i> Ajouter un résultat
      </h2>
    </div>

    <form
      method="post"
      action="{{ url_for('result_new', agent_id=agent.id) }}"
      class="row g-3"
    >
      <!-- Date -->
      <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label">Date </label>
        <input
          type="date"
          class="form-control form-dark"
          name="date_realisation"
          required
        />
      </div>

      <div class="col-12"><hr class="sep" /></div>

      <!-- Grille des tests -->
      <div class="col-12">
        <div class="row g-3">
          <!-- Assis-debout -->
          <div class="col-12 col-lg-6">
            <div class="test-card">
              <div class="test-media">
                <img
                  src="{{ url_for('static', filename='img/assis_debout.png') }}"
                  alt="Assis-debout"
                  class="test-img"
                />
              </div>
              <div class="test-body">
                <div class="test-head">
                  <div>
                    <div class="test-title">Assis-debout</div>
                    <div class="test-sub">Valeurs gauche / droite</div>
                  </div>
                  <div class="diff-badge" id="diff-assis">—</div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <label class="form-label small mb-1">Gauche</label>
                    <input
                      class="form-control form-dark"
                      name="assis_debout_g"
                      placeholder="ex: 12"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Droite</label>
                    <input
                      class="form-control form-dark"
                      name="assis_debout_d"
                      placeholder="ex: 13"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Heel raise -->
          <div class="col-12 col-lg-6">
            <div class="test-card">
              <div class="test-media">
                <img
                  src="{{ url_for('static', filename='img/hell_raise.png') }}"
                  alt="Heel raise"
                  class="test-img"
                />
              </div>
              <div class="test-body">
                <div class="test-head">
                  <div>
                    <div class="test-title">Heel raise</div>
                    <div class="test-sub">Décoller de talon (G/D)</div>
                  </div>
                  <div class="diff-badge" id="diff-heel">—</div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <label class="form-label small mb-1">Gauche</label>
                    <input
                      class="form-control form-dark"
                      name="heel_raise_g"
                      placeholder="ex: 20"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Droite</label>
                    <input
                      class="form-control form-dark"
                      name="heel_raise_d"
                      placeholder="ex: 18"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Side hop -->
          <div class="col-12 col-lg-6">
            <div class="test-card">
              <div class="test-media">
                <img
                  src="{{ url_for('static', filename='img/side_hop.png') }}"
                  alt="Side hop"
                  class="test-img"
                />
              </div>
              <div class="test-body">
                <div class="test-head">
                  <div>
                    <div class="test-title">Side hop</div>
                    <div class="test-sub">Sauts latéraux (G/D)</div>
                  </div>
                  <div class="diff-badge" id="diff-side">—</div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <label class="form-label small mb-1">Gauche</label>
                    <input
                      class="form-control form-dark"
                      name="side_hop_g"
                      placeholder="ex: 10"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Droite</label>
                    <input
                      class="form-control form-dark"
                      name="side_hop_d"
                      placeholder="ex: 11"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Wall test -->
          <!-- Wall test -->
          <div class="col-12 col-lg-6">
            <div class="test-card">
              <div class="test-media">
                <img
                  src="{{ url_for('static', filename='img/wall_test.png') }}"
                  alt="Wall test"
                  class="test-img"
                />
              </div>
              <div class="test-body">
                <div class="test-head">
                  <div>
                    <div class="test-title">Wall test</div>
                    <div class="test-sub">Souplesse (G/D)</div>
                  </div>
                  <div class="diff-badge" id="diff-wall">—</div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <label class="form-label small mb-1">Gauche</label>
                    <input
                      class="form-control form-dark"
                      name="wall_test_g"
                      placeholder="ex: 7.5"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Droite</label>
                    <input
                      class="form-control form-dark"
                      name="wall_test_d"
                      placeholder="ex: 7.5"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bouton -->
      <div class="col-12">
        <button class="btn btn-accent" type="submit">
          <i class="bi bi-check2"></i> Ajouter
        </button>
      </div>
    </form>
  </div>
</div>

<!-- HISTORIQUE -->
<div class="card card-dark">
  <div class="card-body">
    <h2 class="h6 mb-3">
      <i class="bi bi-clipboard-data"></i> Historique des résultats
    </h2>

    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Assis-debout (G/D)</th>
            <th>Heel raise (G/D)</th>
            <th>Side hop (G/D)</th>
            <th>Wall test (G/D)</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
          <tr>
            <td>{{ r.date_realisation.strftime("%Y-%m-%d") }}</td>
            <td>
              {{ r.assis_debout_g or "-" }} / {{ r.assis_debout_d or "-" }}
            </td>
            <td>{{ r.heel_raise_g or "-" }} / {{ r.heel_raise_d or "-" }}</td>
            <td>{{ r.side_hop_g or "-" }} / {{ r.side_hop_d or "-" }}</td>
            <td>{{ r.wall_test_g or "-" }} / {{ r.wall_test_d or "-" }}</td>

            <td class="text-end">
              <form
                class="d-inline"
                method="post"
                action="{{ url_for('result_delete', result_id=r.id) }}"
                onsubmit="return confirm('Supprimer ce résultat ?');"
              >
                <button class="btn btn-sm btn-outline-danger" type="submit">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-muted">
              Aucun résultat pour le moment.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  function lsiDeficitPercent(g, d) {
    const G = parseFloat((g || "").replace(",", "."));
    const D = parseFloat((d || "").replace(",", "."));
    if (isNaN(G) || isNaN(D)) return null;

    const strong = Math.max(G, D);
    const weak = Math.min(G, D);

    if (strong <= 0) return null; // évite division par 0 / valeurs négatives
    const lsi = weak / strong; // 0..1
    const deficit = (1 - lsi) * 100;

    return deficit; // ex: 30 => on affichera -30%
  }

  function setBadge(el, deficit) {
    if (!el) return;

    if (deficit === null) {
      el.textContent = "—";
      el.classList.remove("diff-ok", "diff-warn", "diff-bad");
      return;
    }

    el.textContent = "-" + deficit.toFixed(0) + "%";

    // seuils (à ajuster si tu veux)
    el.classList.remove("diff-ok", "diff-warn", "diff-bad");
    if (deficit <= 10) el.classList.add("diff-ok");
    else if (deficit <= 20) el.classList.add("diff-warn");
    else el.classList.add("diff-bad");
  }

  function bindDiff(badgeId, gName, dName) {
    const badge = document.getElementById(badgeId);
    const gEl = document.querySelector(`[name="${gName}"]`);
    const dEl = document.querySelector(`[name="${dName}"]`);

    const update = () => {
      const deficit = lsiDeficitPercent(gEl?.value, dEl?.value);
      setBadge(badge, deficit);
    };

    if (gEl) gEl.addEventListener("input", update);
    if (dEl) dEl.addEventListener("input", update);
    update();
  }

  document.addEventListener("DOMContentLoaded", () => {
    bindDiff("diff-assis", "assis_debout_g", "assis_debout_d");
    bindDiff("diff-heel", "heel_raise_g", "heel_raise_d");
    bindDiff("diff-side", "side_hop_g", "side_hop_d");
    bindDiff("diff-wall", "wall_test_g", "wall_test_d");
  });
</script>

{% endblock %}
